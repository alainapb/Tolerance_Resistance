---
title: "Spore production"
author: "David Nguyen"
date: "April 30, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
```

# load data

```{r}
names_cols <- read_excel("data/Flow_Cytometry_Spore_Counts_20190710 adjusted gating 7-2 expt corrected.xls",
           sheet = 2, n_max = 1) %>% names()
raw_dat <- 
  read_excel("data/Flow_Cytometry_Spore_Counts_20190710 adjusted gating 7-2 expt corrected.xls",
           sheet = 2, skip = 1, col_names = FALSE) %>% 
  slice(-1) # drop first obs. Just has ALGAE in all cols???
names(raw_dat) <- names_cols
spore_dat <- raw_dat %>% dplyr::select(Genotype, Spore_level = `Spore level`, Animal = `Animal Replicate`, Spore_count = `Spores | Count`)
rm(names_cols, raw_dat)

# load full data set
all_female <- read_csv("data/all_female.csv")
# match Genotype naming conventions
spore_dat <- spore_dat %>% mutate(Genotype = case_when(Genotype == "M252" ~ "Midland 252",
                                          Genotype == "A45" ~ "A45",
                                          Genotype == "M281" ~ "Midland 281",
                                          Genotype == "STD" ~ "Standard"),
                                  Spore_level = as.numeric(Spore_level),
                                  Animal = as.numeric(Animal))
# join spore count data to full data set
all_female <- left_join(all_female, spore_dat, by = c("Genotype", "Spore_level", "Animal"))
# remove duplicate observations
# note, I'm not using feeding rates here, so we don't need both measurements
all_female <- filter(all_female, Technical_Replicate == 1)

# set true zeros for Spore_count (e.g., animals that were exposed but uninfected have a zero spore count)
all_female <- all_female %>% mutate(Spore_count = ifelse(Susceptible == 1 & Infected == 0, 0, Spore_count))

all_female %>% group_by(Susceptible, Infected) %>%
  summarise(n_na = sum(is.na(Spore_count)))

all_female %>%
  filter(is.na(Spore_count)) %>%
  dplyr::select(Genotype, Spore_level, Animal, Infected_Uninfected, Susceptible, Infected)

# create data set for fitting regression models
reg_data <-  filter(all_female, Spore_level > 0) #filter(spore_dat, Spore_level > 0)
```

Grab only genotype, spore level, animal number (some missing?), and spore count.

### which animal numbers are missing?

```{r}
spore_dat %>%
  group_by(Genotype, Spore_level) %>%
  summarise(missing = sum(is.na(Animal)),
            nobs = n()) %>%
  knitr::kable()
```

Not sure why there are 0 level spores. Are they controls of some sort? Anyways, not sure why there are missing labels  for animal number.

# Distribution of spore counts

```{r}
# spore_dat %>%
#   ggplot() + 
#   geom_violin(aes(x = factor(Spore_level), y = Spore_count, fill = Genotype), alpha = 0.3) +
#   geom_jitter(aes(x = factor(Spore_level), y = Spore_count, col = Genotype)) +
#   facet_wrap(~Genotype, scales = "free_y")
all_female %>%
  filter(Spore_level > 0) %>%
  ggplot() + 
  geom_violin(aes(x = factor(Spore_level), y = Spore_count, fill = Genotype), alpha = 0.3) +
  geom_jitter(aes(x = factor(Spore_level), y = Spore_count, col = Genotype)) +
  facet_wrap(~Genotype, scales = "free_y")
```

```{r}
# log(x + 0.5)
clog <- function(x) log(x + 0.5)

all_female %>%
  filter(Spore_level > 0) %>%
  ggplot() + 
  geom_jitter(aes(x = factor(Spore_level), 
                  y = clog(Spore_count), col = Genotype))
```


Signs of zero inflation for A45, M252, M281. Possible for STD too. The distributions of A45 and STD are very broad, I'm worried there will still be overdispersion after acounting for zero inflation. May need to include random effect at observation level.

# Fit regular poisson and NB regression

```{r}
fit.pois <- glm(Spore_count ~ Genotype*factor(Spore_level), family = poisson(), data = reg_data)
fit.nb <- MASS::glm.nb(Spore_count ~ Genotype*factor(Spore_level), data = reg_data)

# compare predictions to observed means
pred_dat <- expand_grid(Genotype = unique(spore_dat$Genotype)[1:4],
                        Spore_level = c("150","300"))
pred_dat$pois <- predict(fit.pois, newdata = pred_dat, type = "response")
pred_dat$nb <- predict(fit.nb, newdata = pred_dat, type = "response")

obs_dat <- reg_data %>% group_by(Genotype, Spore_level) %>% 
  summarise(obs_mean = mean(Spore_count, na.rm = TRUE)) %>%
  mutate(Spore_level = factor(Spore_level))
inner_join(pred_dat, obs_dat, by = c("Genotype", "Spore_level"))  %>% knitr::kable(digits = 2)
```

It makes sense that these match, because the MLE of the means for Poisson and NB will just be the group sample means.

### Compare observed vs predicted zeros

```{r}
zero_count <- reg_data %>% 
  group_by(Genotype, Spore_level) %>% 
  summarise(zeros = sum(Spore_count == 0, na.rm = TRUE),
            nobs = n()) %>%
  mutate(Spore_level = factor(Spore_level)) # so I can join it with pred_dat
zero_count <- inner_join(zero_count, pred_dat , by = c("Genotype", "Spore_level"))

zero_count <-
  zero_count %>% 
  mutate(pois_zeros = dpois(0, lambda = pois),
         pois_zeros = nobs * pois_zeros,
         nb_zeros = dnbinom(0, mu = nb, size = fit.nb$theta),
         nb_zeros = nobs * nb_zeros)
```

```{r}
zero_count %>% select(-pois, - nb) %>% knitr::kable()
```

The poisson model always dramatically underestimates the number of zeros. The negative binomial model does a better job of predicting close to the observed number of zeros for each Genotype x spore level: too high for A45, about right for the M252, too low for midland 281, and too high for standard.

```{r}
zero_count %>% summarise(zeros = sum(zeros),
                         pois_zeros = sum(pois_zeros),
                         nb_zeros = sum(nb_zeros)) %>% knitr::kable()
```

Poisson model is still bad. For the NB model the number of zeros is low for midland 281 but high for all other genotypes.

```{r}
zero_count %>% ungroup() %>% summarise(zeros = sum(zeros),
                         pois_zeros = sum(pois_zeros),
                         nb_zeros = sum(nb_zeros)) %>% knitr::kable()
```

The total number of zeros predicted in the data set by the nb model is pretty good. But, it has issues with some genotypes. For instance, it predicts too many zeros for standard, but not enough zeros for M281. I think these issues would be resolved by using a zero-inflated or hurdle model.


# zero-inflated and hurdle models

For all of these models I will only include genotype as a covariate for the binomial part of the model since that was the best model for infection outcomes.


```{r}
library(countreg)

# poisson
# hurdle_poisson_full <-   hurdle(Spore_count ~ Genotype*factor(Spore_level) | Genotype, 
#        dist = "poisson", zero.dist = "binomial", data = reg_data)
# zi_poisson_full <- zeroinfl(Spore_count ~ Genotype*factor(Spore_level) | Genotype, 
#        dist = "poisson", link = "logit", data = reg_data)
# hurdle_poisson_main <-   hurdle(Spore_count ~ Genotype + factor(Spore_level) | Genotype, 
#        dist = "poisson", zero.dist = "binomial", data = reg_data)
# zi_poisson_main <- zeroinfl(Spore_count ~ Genotype + factor(Spore_level) | Genotype, 
#        dist = "poisson", link = "logit", data = reg_data)

# negative binomial
# hurdle_nb_full <-   hurdle(Spore_count ~ Genotype*factor(Spore_level) | Genotype, 
#        dist = "negbin", zero.dist = "binomial", data = reg_data)
zi_nb_full <- zeroinfl(Spore_count ~ Genotype*factor(Spore_level) | Genotype, 
       dist = "negbin", link = "logit", data = reg_data)
# hurdle_nb_main <-   hurdle(Spore_count ~ Genotype + factor(Spore_level) | Genotype, 
#        dist = "negbin", zero.dist = "binomial", data = reg_data)
zi_nb_main <- zeroinfl(Spore_count ~ Genotype + factor(Spore_level) | Genotype, 
       dist = "negbin", link = "logit", data = reg_data)
# hurdle_nb_geno <-   hurdle(Spore_count ~ Genotype | Genotype, 
#        dist = "negbin", zero.dist = "binomial", data = reg_data)
zi_nb_geno <- zeroinfl(Spore_count ~ Genotype | Genotype, 
       dist = "negbin", link = "logit", data = reg_data)
zi_nb_null <- zeroinfl(Spore_count ~ 1 | Genotype, 
       dist = "negbin", link = "logit", data = reg_data)
```

```{r}
bbmle::AICctab(zi_nb_full, zi_nb_main, zi_nb_geno, zi_nb_null)
```

The ZINB models with genotype only, intercept only, and genotype + spore level are all about the same wrt to AICc. We can choose to use the genotype only model on scientific grounds, i.e., we want to estimate genotype specific differences.

```{r}
summary(zi_nb_geno)
```

```{r}
library(emmeans)

predict(zi_nb_geno, newdata = data.frame(Genotype = unique(reg_data$Genotype)), type = "response")
predict(zi_nb_geno, newdata = data.frame(Genotype = unique(reg_data$Genotype)), type = "count")
predict(zi_nb_geno, newdata = data.frame(Genotype = unique(reg_data$Genotype)), type = "zero")

# get estimated marginal means from genotype only model
emm_response <- emmeans(zi_nb_geno, "Genotype", mode = "response") # arithmatic mean
emm_count_lin <- emmeans(zi_nb_geno, "Genotype", mode = "count", lin.pred = T) # geometric mean
emm_count <- emmeans(zi_nb_geno, "Genotype", mode = "count")
emm_prob0 <- emmeans(zi_nb_geno, "Genotype", mode = "prob0")

# confidence interval for response
confint(emm_response, level = 0.95, adj = "none")
confint(emm_response, level = 0.95, adj = "Sidak")
confint(contrast(emm_response, "pairwise"), adj = "none")
confint(contrast(emm_response, "pairwise"), adj = "Tukey")

# confidence interval for conditional mean (count)
# confidence interval for response
confint(emm_count, level = 0.95, adj = "none")
confint(emm_count, level = 0.95, adj = "Sidak")
confint(contrast(emm_count, "pairwise"), adj = "none")
confint(contrast(emm_count, "pairwise"), adj = "Tukey")

```


# bayesian zero inflated model

```{r }
library(brms)
```


```{r }
set.seed(123)
# brm_zi_nb_null <- brm(bf(Spore_count ~ 1, zi ~ Genotype), 
#                  data = all_female, family = zero_inflated_negbinomial())
# saveRDS(brm_zi_nb_null, "models/zi_nb_null.RData")
brm_zi_nb_null <- readRDS("models/zi_nb_null.RData")
```

```{r}
rhat(brm_zi_nb_null)
```

all r-hat values close to 1 which suggests that chains converged.

```{r }
summary(brm_zi_nb_null)
plot(conditional_effects(brm_zi_nb_null), ask = FALSE)
```

```{r}
plot(brm_zi_nb_null, ask = FALSE)
```

```{r}
# fixed effects in model
fixef(brm_zi_nb_null)
```

```{r}
# get unconditional mean spore count = prob
zi_nb_null_uncond_mean <- 
  posterior_samples(brm_zi_nb_null) %>%
  transmute(A45 = exp(b_Intercept) * (1 - boot::inv.logit(b_zi_Intercept)),
         M252 = exp(b_Intercept) * (1 - boot::inv.logit(b_zi_Intercept + b_zi_GenotypeMidland252)),
         M281 = exp(b_Intercept) * (1 - boot::inv.logit(b_zi_Intercept + b_zi_GenotypeMidland281)),
         standard = exp(b_Intercept) * (1 - boot::inv.logit(b_zi_Intercept + b_zi_GenotypeStandard))
         ) 
# re-format to be long df
zi_nb_null_uncond_mean_long <- 
  zi_nb_null_uncond_mean %>%
  pivot_longer(cols = everything(),names_to = "Genotype", values_to = "mean_spore")

# get posterior mean and 95% CrI
zi_nb_null_mean_summary <-
  zi_nb_null_uncond_mean_long %>%
  group_by(Genotype) %>%
  summarise(mean = mean(mean_spore),
            lwr = quantile(mean_spore, prob = 0.025),
            upr = quantile(mean_spore, prob = 0.975))
# output table of mean and CrI
zi_nb_null_mean_summary %>%
  knitr::kable(digits = 2)

# plot unconditional genotype-specific mean spore load
plot_zi_nb_null_mean <- zi_nb_null_uncond_mean_long %>%
  ggplot(aes(x = factor(Genotype))) +
  geom_violin(aes(y =mean_spore, fill = Genotype), alpha = 0.5) +
  geom_point(data = zi_nb_null_mean_summary, aes(y = mean)) +
  geom_errorbar(data = zi_nb_null_mean_summary, aes(ymin = lwr, ymax = upr), width = 0.2)

plot_zi_nb_null_mean

# make plot with observed data too
obs_spore_mean <- all_female %>% group_by(Genotype) %>%
  mutate(Genotype = case_when(Genotype == "A45" ~ "A45",
                              Genotype == "Midland 252" ~ "M252",
                              Genotype == "Midland 281" ~ "M281",
                              Genotype == "Standard" ~ "standard")) %>%
  summarise(mean = mean(Spore_count, na.rm = TRUE),
            n = n())

plot_zi_nb_null_mean + geom_point(data = obs_spore_mean, aes(x = factor(Genotype), y = mean, size = log(n))) +
  labs(x = "Genotype",
       y = "Mean spore count",
       size = "log(sample size)")
```


To make inferences about differences between genotypes, lets compute the pairwise differences between each genotype and get the posterior distributions of the differences.

```{r}
col_diff<-function(df)
{
    dif_fn<-function(obj){return(obj[[1]]-obj[[2]])}
    tmp_fn<-function(inp_row){unlist(combn(inp_row,2,FUN=dif_fn,simplify = FALSE))}
    intres<-t(apply(df,1,tmp_fn))
    colnames(intres)<-unlist(combn(colnames(df),2,simplify = FALSE,FUN=function(obj){paste(obj[[1]],obj[[2]],sep="-")}))
    temp<-cbind(df, intres)
    return(temp)

}
zi_nb_null_diff <- 
  zi_nb_null_uncond_mean %>% col_diff() %>%
  dplyr::select(-c("A45", "M252", "M281", "standard"))

# reformat to be long
zi_nb_null_diff_long <- 
  zi_nb_null_diff %>%
  pivot_longer(cols = everything(), names_to = "contrast", values_to = "difference")
# get posterior mean and 95% CrI
zi_nb_null_diff_summary <-
  zi_nb_null_diff_long %>%
  group_by(contrast) %>%
  summarise(mean = mean(difference),
            lwr = quantile(difference, 0.025),
            upr = quantile(difference, 0.975))

plot_zi_nb_null_diff <- zi_nb_null_diff_long %>%
  ggplot(aes(x = factor(contrast))) +
  geom_violin(aes(y =difference, fill = contrast), alpha = 0.5) +
  geom_point(data = zi_nb_null_diff_summary, aes(y = mean)) +
  geom_errorbar(data = zi_nb_null_diff_summary, aes(ymin = lwr, ymax = upr), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", col = "red")
  
obs_spore_mean_diff <- obs_spore_mean %>% dplyr::select(-n) %>%
  pivot_wider(names_from = "Genotype", values_from = "mean") %>%
  col_diff() %>%
  dplyr::select(-c("A45", "M252", "M281", "standard")) %>%
  pivot_longer(cols = everything(), names_to = "contrast", values_to = "difference")
  
# difference between unconditional mean spore counts
# red dot is observed difference in mean
plot_zi_nb_null_diff + geom_point(data = obs_spore_mean_diff, aes(x = factor(contrast), y = difference), col = "red")
```

